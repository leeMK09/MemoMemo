## DLQ/DLT 의 순서보장은 어떻게 해야할까?

DLT(Dead Letter Topic/Queue) 재처리 환경에서 **메시지 순서 보장**을 어떻게 달성할까?

</br>

### 왜 순서 보장이 어려울까?

- 네트워크 지연과 일시적 오류로 메시지가 늦게 도착하거나 재시도되면서 순서가 뒤섞입니다 
- 서비스별 처리 속도가 다르거나, 병렬 소비 설정 때문에 동일 키의 이벤트가 엇갈려 처리될 수 있습니다 
- DLT 에서 재처리된 늦은 이벤트가 **기존 상태를 되돌리는 문제**를 유발합니다 

</br>

### 전략 

- 멱등성 강화 
    - 같은 이벤트가 여러번 와도 최종 상태가 같도록 만들기 
- 순서 재정렬 
    - 키별 순번과 버퍼로 처리 순서를 맞추기 
- 이벤트 소싱 
    - 이벤트 로그를 단일 진실 공급원(SSOT)으로 보고 최종 상태를 재계산 
- 후 보정 작업 (Reconcilication)
    - 원본과 목표 시스템을 주기적으로 비교 및 보정 

</br>

### 1. 멱등성(Idempotency) 강화 

- 조건부 업데이트 (Optimistic Lock)
    - 테이블에 `version` 컬럼을 두고 업데이트 시 현재 버전을 조건으로 검증합니다 
        - 예시) `UPDATE T SET ..., version = 6 WHERE id = k AND version 5`
    - 더 앞선 이벤트가 먼저 처리되었다면 0개의 row 업데이트로 안전하게 무시됩니다 
- 고유한 이벤트 ID 로 중복 차단 
    - 이벤트마다 ID 를 부여하고 처리 이력 테이블을 두어 중복을 건너뜁니다 
    - DB 의 `INSERT ... ON CONFLICT DO NOTHING` (PostgreSQL) , `INSERT ... ON DUPLICATE KEY UPDATE` (MySQL) 등 활용 
- 상태 전이 규칙 고정 
    - 예시) `CREATED` → `PAID` → `SHIPPED` → `DELIVERED`
    - 현재 상태가 `SHIPPED` 인데 늦게 온 `PAID` 는 무시 및 기록, 상태 전이 자체에 멱등성을 부여합니다

</br>

### 2. 순서 재정렬과 상태 관리 

- 시퀀스 번호 필수 
    - 동일 키 (주문 ID 등) 기준으로 이벤트에 순번을 매깁니다 
    - 컨슈머는 "키별 마지막 처리 순번"을 저장하고 다음 순번만 처리합니다 
- 버퍼링과 타임아웃 
    - 3번이 먼저 오고 2번이 없으면 3번을 잠시 버퍼에 둡니다 
    - 타임아웃을 넘기면 정책에 따라 
        - 보류 유지, 부분 처리, DLT 이동, 알림 트리거 등을 선택합니다 
- 저장 후 순차 처리 
    - 이벤트를 먼저 저장하고 "마지막 순번 + 1"이 존재할 때만 처리하여 연속성을 확보합니다 

</br>

### 3. 이벤트 소싱 (Event Sourcing)

- 모든 상태 변경을 이벤트로 기록하고, 최종 상태는 이벤트를 재생(Replay)해서 계산합니다 
- 늦게 도착한 이벤트도 로그에 추가만 하면 재생 시 자연스럽게 반영됩니다 
- 정합성, 추적성이 우수합니다 
- 저장소 비용과 재생 비용이 들며 조회 최적화가 필요합니다 

</br>

### 4. 주기적 보정 (Reconciliation)

- 원본 시스템 vs 대상 시스템 비교 배치 
    - 예시) 주문 서비스(A) 와 재고 서비스(B) 의 전일 데이터 비교 
    - 누락 및 불일치 항목을 로그, 알림, 자동 재처리로 보정합니다 
- 금융 도메인 
    - 거래 이벤트 합 vs 계좌 잔액을 주기적으로 대조하여 불일치 탐지 및 교정 

</br>
</br>

## 조합 예시 

1. 기본으로 멱등성을 사용하여 중복, 역순 업데이트를 무효화 
2. 키별 시퀀스와 버퍼로 순차 처리를 보장 
3. 주기적인 후보정 배치 작업을 통해 누락 혹은 불일치를 자동 보정 

</br>
</br>

## 설계 시 

- 키 설계
    - 순서 보장이 필요한 "Aggregate Key (주문 ID 등)" 을 명확히 정의해야 한다 
- 스키마 설계 
    - `event_id`, `sequence_no`, `version`, `processed_at`, `status` 필드 등을 통해 추적이 쉽도록 해야한다 
- 재시도 정책 
    - 지수 백오프 → DLT 이동 기준을 수치화하여 문서로 정리 
- 관측성 
    - 키별 마지막 순번, 버퍼 큐의 길이, 불일치 건수 대시보드화 하여 모니터링할 수 있도록 하는 것도 좋다 
- 장애 시나리오 리허설 
    - 지연 이벤트, 중복 이벤트, 역순 도착을 시나리오에 따라 재현, 주기적으로 카나리 테스트 


