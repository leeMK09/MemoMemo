## 무중단 배포 

**롤링 배포**

- 소규모에서 주로 사용된다 
- 만약 로드밸런서를 사용한다면 배포할 부분을 로드밸런서에서 떼어낸 다음 배포를 진행해야 한다
- 운영되는 서버를 순차적으로 배포한다 
- 트래픽이 균등할때 배포한다 
    - 트래픽이 크게 변경되지 않는 부분에서 사용
    - 운영하는 서버 수는 동일하게 설정한 후 배포 
- EKS 는 아무 설정이 없다면 기본적으로 롤링 배포 방식을 수행한다 
- 실무에서는 많이 사용하지 않는다 
- 서버를 재활용하는 방식 → 운영 환경과 배포시의 환경이 나뉘지 않는다 
- `v1`, `v2` 가 공존한다 
- 롤백이 쉽지 않다 
- 배포가 느리다 → 순차적으로 진행함 

</br>

**블루/그린 배포**

- 기존 운영중인 환경에서 배포하는 것이 아닌 새로운 환경에서 배포를 수행한다 
    - 배포 환경 새롭게 구축 → 새로운 서브넷 혹은 AZ 를 구성 
- 기존 운영은 블루 환경 
- 새로운 배포 환경은 그린 환경 
- 배포 시점에만 그린 환경을 구성하고 정상동작을 확인하면 이후에 한번에 이동한다 
    - 기존 블루 환경은 마이그레이션이 완료되면 제거한다 
- **블루/그린 환경을 모두 활성화하고 사용하기도 한다**
    - 대형 이커머스에서 사용하기도 한다 
    - **장점은 롤백이 빠르다**
    - **즉, 장애가 발생하였을때 복구가 더 빠르며 장점**
- **v2 에서 스키마가 변경되었다면 하위 호환을 한 뒤 배포를 진행해야 한다**
- **빠른 롤백을 위해서 블루/그린 배포를 사용하는 것은 아니다**
- **CNAME SWAP (DNS 설정) 을 통해 한 번에 이동하기도 한다**
- AWS ELB (ALB) Listener 에서 경로 패스에 대한 대상 그룹 라우팅 설정이 가능하다 

</br>

**Canary 배포**

- 배포시 문제를 빠르게 발견할 수 있다 
- 사용자 관점으로 배포된 서버를 노출한다 
- 점진적으로 배포한다 
    - 5% → 10% → 20% ...
- 문제가 발생하면 소수만 영향을 받는다 
- A/B 테스트 시 사용하기도 한다 
    - UX/UI 변경 시 구매율이 증가했다 등의 결과를 비교한다 
    - 두 가지 버전을 동시에 사용하여 각 버전의 성과 지표를 확인한다 
    - A/B 테스트의 경우 클릭율 등의 비즈니스 지표를 많이 보기도 한다 
- **배포 문제 영향을 최소화하는 것이 목적이라면 에러율, 응답속도 등의 지표를 더 많이 봐야한다**
- AWS ELB(ALB) 가중치 기반으로 라우팅하여 Canary 배포를 구성하기도 한다 

**실무에서는 블루/그린과 Canary 배포를 혼합하여 사용하기도 한다**
- 추천하는 진행 방식 
    - 먼저 블루/그린 배포 이후 환경에 따라 Canary 배포가 더 이점을 가져온다면 부분적으로 구성한다
- 처음부터 Canary 배포를 하는 곳은 없다
- 금융 서비스 같은 서비스 안정성이 최우선이라면 블루/그린 배포를 사용하기도 한다 
    - 장애 발생 → 빠른 롤백 → 이후 장애 대응

</br>

**배포시 스키마가 달라진다면?**
- 변경된 버전에서 Redis 의 특정 데이터의 스키마가 변경되었다면 
- 해결 방안 
    - `v1:UserSession:{userId}`
    - `v2:UserSession:{userId}`
        - 캐시 키에 버저닝을 사용 
    - `nullable` OR `@JsonIgnoreProperties(ignoreUnkown = true)` 를 활용하기도 한다
