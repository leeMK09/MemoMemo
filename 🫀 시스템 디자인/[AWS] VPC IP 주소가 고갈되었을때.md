## VPC IP 주소가 고갈되었을때

- 여러가지 원인에 의해 IP 주소가 고갈될 수 있다
  - 서브넷을 Auto Scaling/ECS Task 개수를 고려하지 못해 작게 설정한 경우
  - ENI를 많이 사용하는 서비스 (EKS, Lambda VPC 연결, ECS awsvpc 모드 등)
  - AZ 별로 동일한 서브넷 크기를 쓰다보니 특정 AZ만 고갈
  - NAT Gateway, ALB 같은 인프라 리소스까지 합하여 소비한 경우

</br>

### Secondary CIDR Block 추가

- 기존 VPC 의 CIDR 은 수정 및 확장이 불가능하다
- 대신 VPC 에 새로운 CIDR 블록을 추가해서 주소공간을 늘린다
  - 즉 기존 CIDR 은 그대로 있고 새로운 CIDR 공간을 추가하는 방식
  - 기존 VPC CIDR 와 겹치면 안됨, VPC 피어링 / Transit Gateway / VPN / Direct Connect 등 연결된 네트워크들과도 겹치면 안됨
- 단점
  - 결국 기존 서브넷 고갈은 새로운 서브넷을 만들어 워크로드를 옮겨야 해결된다
  - 온프레미스/다른 VPC 와 이미 연결된 환경에서는 겹치지 않는 대역을 찾기가 어려울 수 있음

</br>

### 새로운 VPC 를 만들고 Transit Gateway 로 멀티 VPC 구성

- 새로운 VPC (충분히 큰 CIDR)를 만들고 Transit Gateway 를 통해 기존 VPC 와 연결해서 확장한다
- 대규모 아키텍쳐에서 네트워크 분리가 필요할때 이상적인 선택이다
- IP 충돌을 피하기 좋다 → 설계를 새롭게 시작하므로
- 확장성이 좋고 리전 간 연결 (inter-region) 같은 요구사항에도 유리하다
- 단점 및 고려사항
  - 비용 (Transit Gateway 자체 비용 + 데이터 처리 비용)과 운영 복잡도 증가
  - 라우팅 테이블(전파/연결) 설계를 잘못한다면 통신에 이슈가 발생할 수 있음
  - 보안 및 가시성(Flow Logs 등) 또한 VPC 단위로 늘어남 → 모니터링이 복잡함

</br>

### 기존 리소스를 새로운 VPC 로 마이그레이션

- 더 큰 CIDR 를 가진 새로운 VPC 를 설계하여 기존 서비스들을 단계적으로 옮긴다
- Elastic IP, Route53, LB 를 이용하여 트래픽을 새로운 VPC로 점진적 전환이 가능하다
- 마이그레이션 패턴
  - 새로운 VPC 에 동일한 서비스 스택 및 환경을 구축
  - Route53 레코드 변경(가중치, 지연시간 기반 등) 또는 ALB/NLB 를 통한 트래픽 전환
  - DB의 경우 가능하면 DB는 그대로 두고 앱만 옮기기 (연결은 Transit Gateway 또는 VPC Peering)
  - 혹은 DB 까지 옮기는 경우 복제 및 DB 작업에 특화된 마이그레이션 전략이 필요함
- 단점
  - 가장 큰 프로젝트가 될 수 있음 → 운영시 리스크 발생

</br>

## 제약사항

**Primary CIDR 는 변경 및 삭제 불가능**

- VPC 를 생성할 때 설정한 Primary CIDR 는 절대 수정 및 삭제가 불가능하다
- 그래서 확장하려면 Secondary CIDER 추가 또는 새로운 VPC 를 설계해야 한다

**CIDR 은 절대 겹치면 안됨**

- 같은 VPC 의 다른 CIDR 들과도 겹치면 안되며 피어링된 VPC, 온프레미스(VPN), 연결된 네트워크 전체와도 겹치면 안된다

**VPC CIDR 블록 개수 제한**

- 기본적으로 VPC 당 CIDR 블록은 최대 5개 (기본 한도) → 필요하다면 한도 상향 요청을 해야할 수 있음

**RFC1918 제약**

- RFC1918 은 사설 IP 대역을 의미한다
  - 10.0.0.0/8
  - 172.16.0.0/12
  - 192.168.0.0/16
- 만약 Primary CIDR 이 RFC1918 즉 사설 대역이라면 Secondary CIDR 도 같은 RFC1918 범위 안에서만 추가할 수 있다
- 즉 10.0.0.0/8 대역으로 설정을 했으면 172.16.0.0/12 대역을 추가하는 것은 불가능하다
- 허용 예시 (같은 RFC1918 범위)
  - Primary: 10.0.0.0/16 → Secondary: 10.1.0.0/16
  - Primary: 172.16.0.0/16 → Secondary: 172.20.0.0/16
- 불가능한 예시 (다른 RFC1918 범위)
  - Primary: 10.0.0.0/16 → Secondary: 172.16.0.0/16
  - Primary: 192.168.0.0/16 → Secondary: 10.2.0.0/16
