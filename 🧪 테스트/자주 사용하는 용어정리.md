## 자주 사용하는 용어 정리

**SUT**

- System under test (테스트 하려는 대상)

예시)

```java
@Test
void 유저는_북마크를_toggle_할_수_있다() {
    User user = new User();

    user.toggleBookmark("mark");

    boolean result = user.hasBookmark("mark");
    assertThat(result).isTrue();
}
```

- 여기서 SUT 는 테스트 하려는 대상 즉, `User`

```java
@Test
void 유저는_북마크를_toggle_할_수_있다() {
    User sut = new User();

    sut.toggleBookmark("mark");

    boolean result = sut.hasBookmark("mark");
    assertThat(result).isTrue();
}
```

</br>

**BDD**

- Behaviour driven development (given - when - then)
- 테스트 코드를 작성하다보면 모든 메서드를 다 테스트하고 싶은 욕구가 생김
- 메서드 위주의 테스트 코드보다는 시나리오에 기반한 테스트를 작성하는 방식

예시)

- 어떤 상황이 주어지고 (given)
- 어떤 행동을 할 때 (when)
- 이렇게 되더라 (then)

</br>

**flaky**

- 불규칙한 테스트
- 대상 코드에 아무런 변경이 없음에도 불구하고 실패하는 테스트

</br>
</br>

## 테스트 더블

- 테스트 대역

</br>

**Dummy**

- 아무런 동작도 하지 않고, 그저 코드가 정상적으로 돌아가기 위해 전달하는 객체

```java
@Test
void 이메일_회원가입을_할_수_있다() {
    Request request = new Request("test@test.com");

    sut.register(request);

    User user = userRepository.getByEmal("test@test.com");
    assertThat(user.isPending()).isTrue();
}

// Dummy
class DummyRegisterEmailSender implements RegisterEmailSender {

    @Override
    public void send(String email, String message) {
        // do nothing
    }
}
```

</br>

**Fake**

- Local 에서 사용하거나 테스트에서 사용하기 위해 만들어진 가짜 객체, 자체적인 로직이 있다는게 특징

```java
@Test
void 이메일_회원가입을_할_수_있다() {
    Request request = new Request("test@test.com");

    sut.register(request);

    User user = userRepository.getByEmal("test@test.com");
    assertThat(user.isPending()).isTrue();
}

// Fake
class FakeRegisterEmailSender implements RegisterEmailSender {

    private final Map<String, List<String>> latestMessages = new HashMap<>();

    @Override
    public void send(String email, String message) {
        List<String> records = latestMessages.getOrDefault(email, new ArraList<>());
        records.add(message);
        latestMessages.put(email, records);
    }

    public Optional<String> findLatestMessage(String email) {
        return latestMessages.getOrDefault(email, new ArrayList<>()).stream().findFirst();
    }
}
```

</br>

**Stub**

- 미리 준비된 값을 출력하는 객체
- 테스트 대상이 의존하는 외부 컴포넌트의 동작을 흉내낼때 자주 사용하는 객체
  - 즉, 미리 정해진 입력 → 출력(상태) 만 제공
- 출력된 결과(상태)를 검증하는 데 초점을 둔다

```java
// Stub
class StubUserRepository implements UserRepository {

    public User getByEmail(String email) {
        if (email.equals("foo@bar.com")) {
            return new User("foo@bar.com", "PENDING");
        }
        throw new UsernameNotFoundException(email);
    }
}
```

```java
// Stub mokito 프레임워크를 이용

given(userRepository.getByEmail("foo@bar.com")).willReturn(new User("foo@bar.com", "PENDING"));

assertTrue(user.isRegistered()); // 상태 검증
```

</br>

**Mock**

- 메서드 호출을 확인하기 위한 객체, 자기 검증 능력을 갖춤
- 사실상 테스트 더블과 동일한 의미로 사용됨
- "어떤 동작이 일어났는가?" 를 검증하는데 목적을 둠
- 결과보다는 "호출되었는가?", "몇 번 호출되었는가?", "해당 인자로 호출되었는가?" 같은 행위를 검증할때 자주 사용
- 즉, 행위를 검증한다

```java
class MockMailer implements Mailer {
    private boolean hasBeenCalled = false;

    public void sendWelcomeEmail(UserId userId) {
        this.hasBeenCalled = true;
    }

    public boolean hasBeenCalled() {
        return this.hasBeenCalled;
    }
}

// Test
@Test
void 회원가입_이메일_발송_테스트() {
    EmailService mock = mock(EmailService.class);
    UserService service = new UserService(mock);

    service.register("mk@test.com");

    verify(mock).send("mk@test.com"); // 행위 검증
}
```

</br>

**Spy**

- 메서드 호출을 전부 기록했다가 나중에 확인하기 위한 객체

```java
class EventDispatcherSpy implements EventDispatcher {
    private List<Object> events = new ArrayList<>();

    public void dispatch(Object event) {
        events.add(event);
    }

    public List<Object> dispathcedEvents() {
        return this.events;
    }
}
```

- 참고
  - [Mock과 Stub의 차이 질문](https://www.inflearn.com/community/questions/1257985/mock%EA%B3%BC-stub%EC%9D%98-%EC%B0%A8%EC%9D%B4%EA%B0%80-%EC%95%84%EC%A7%81-%EC%9E%98-%EA%B5%AC%EB%B6%84%EB%90%98%EC%A7%80-%EC%95%8A%EC%8A%B5%EB%8B%88%EB%8B%A4?gad_source=1&gad_campaignid=20714471420&gbraid=0AAAAADAClSB48ttcNBsmlzysq5Cw2aZFO&gclid=CjwKCAjwup3HBhAAEiwA7euZuku9sSbb7S0x8gsX0y9EnTZD9UUE6WYpWlYy8d_aMPKqXEQEa8RB1xoCXdAQAvD_BwE)
