"한 번에 대량으로 객체를 생성하는 것은 주의를 해야 한다!"

예시)

- 콘텐츠 조회 API 가 한 번에 10만 개의 게시글을 반환할 수 있다고 가정
- 게시글 하나가 0.5KB 의 메모리를 사용한다면 10만 개의 게시글은 대략 50MB 메모리를 차지하게 된다
- 만약 동시에 100 명 사용자가 조회 API 를 호출하여 10 만 개의 게시글을 조회한다면 약 4.9GB 의 메모리가 필요해진다

</br>
</br>

### 대량으로 객체가 생성되는 것을 방지하려면 조회 범위를 제한해야 한다

- 10년치 거래 내역을 한 번에 조회할 수 있도록 하기보다는 최대 3개월치만 거래 내역을 조회할 수 있게 하는 식으로 말이다
- 마찬가지로 한 번에 조회할 수 있는 데이터의 개수도 트래픽 규모와 메모리 크기에 맞춰 제한해야 한다

</br>
</br>

### 파일 다운로드와 같은 기능을 구현할 때는 스트림을 활용하자

```java
// 파일을 한 번에 메모리에 로딩
byte[] bytes = Files.readAllBytes(Path.of("path"));
out.write(bytes);
```

위 자바 코드처럼 파일 데이터를 한꺼번에 메모리에 로딩한 후에 응답하는 방식은 피해야 한다

파일 크기와 동시 사용자 수에 따라 메모리 사용량이 급증할 수 있기 때문이다

- 위 코드가 30MB 크기의 파일을 100명이 동시에 다운로드 하면 약 3GB 의 메모리가 필요하다

스트림을 활용하면 파일 처리 과정에서 필요한 메모리 크기를 줄일 수 있다

```java
InputStream is = Files.newInputStream(Path.of("path"));
byte[] buffer = new byte[8192]; // 8KB 메모리
int read;

while ((read = is.read(buffer, 0, 8192)) >= 0) {
    out.write(buffer, 0, read);
}
// is.transferTo(out) 과 동일한 코드
```

이 코드는 파일을 한 번에 읽지 않고 8KB 씩 끊어서 읽는다.

동시에 100명이 다운로드를 요청하더라도 필요한 메모리는 800KB 에 불과하다

> 대량 데이터를 한 번에 메모리에 올려서 서버가 중지된 사례
>
> 엑셀 생성, 엑셀 다운로드 기능 중 OOM 발생
>
> 힙 덤프 분석 결과, 메모리에서 가장 높은 비중을 차지하고 있는 객체는 엑셀 생성과 관련된 객체였다
> 누군가가 엑셀 다운로드 기능을 실행했는데, 조회한 데이터가 수백만 건에 달했다.
> 엑셀 파일을 생성하는 과정에서 모든 데이터가 메모리에 올라갔다.
> 엑셀 생성 시간이 길어지자 사용자는 요청을 취소하고 다시 엑셀 다운로드를 시도했다.
> 동일한 데이터가 다시 메모리에 올라갔고, 이 과정에서 엑셀 생성을 위한 메모리 사용량이 급증하면서 메모리 부족 현상이 발생한 것 이다
>
> 이 문제를 해결하기 위해 2 가지 조치를 취했다.
>
> 1. 먼저 엑셀을 메모리에서 생성하지 않고, 로컬 파일에 스트림 형태로 만들도록 변경했다
>
> 2. 엑셀을 생성하기 위해 필요한 데이터를 조회하는 방식을 개선했다
>    - 기존에 DB 에서 조회한 결과를 리스트로 한 번에 받아 처리했지만
>    - 스트림 형태로 받아 순차적으로 처리하는 방식으로 수정했다
>
> by. 주니어 백엔드 개발자가 반드시 알아야 할 실무 지식(최범균 저자)
