## NAT

- 내부 호스트가 외부로 나갈 때 NAT 는 (내부 IP:Port <-> 외부 IP:Port) 매핑 테이블을 만든다
- 앞으로 나올 NAT 방식들의 핵심 차이는 외부에서 들어오는 패킷을 허용할 때 무엇을 기준으로 판단하는가이다
- NAT 는 항상 내부 → 외부 패킷으로 상태(state)를 만들고 외부 → 내부 패킷은 그 상태를 기준으로 통과 여부를 결정한다

**공통 전제**

- 내부 호스트 : `10.0.0.10:50000`
- NAT 외부 IP : `203.0.113.1`

</br>

### Full Cone NAT (Cone NAT)

- 내부 호스트 `10.0.0.10:50000` 이 외부 서버 `8.8.8.8:53` 으로 패킷을 보낼때 NAT 는 다음과 같이 단순한 매핑 하나를 만든다
  - `10.0.0.10:50000` <-> `203.0.113.1:40000`
- 해당 매핑이 어떤 외부 IP/Port 로 나갔는지와 무관하게 하나로 고정된다는 점이다
- 외부 → 내부 패킷 허용 기준
  - 목적지가 `203.0.113.1:40000` 이라면 출발지가 누구든 상관없이 내부 `10.0.0.10:50000` 으로 전달한다
  - 즉 외부 IP, 외부 Port 전부 검사하지 않는다
- 왜 Full Cone 인가
  - 외부에서 볼때 `203.0.113.1:40000` 으로 들어오는 모든 트래픽이 원뿔(cone) 처럼 전부 내부 호스트로 빨려 들어간다는 개념
- 장점
  - P2P, VoIP, WebRTC 연결성이 좋다
- 단점
  - 보안적으로 가장 취약하며 포트 스캐닝에 그대로 노출된다

</br>

### Restricted Cone NAT

- 상태 생성 방식이며 상태 테이블 자체는 Full Cone NAT 방식과 동일하다
  - `10.0.0.10:50000` <-> `203.0.113.1:40000`
- 하지만 NAT 는 추가적으로 내부 호스트가 접속한 외부 IP 목록을 기억한다
- 외부 → 내부 패킷 허용 기준
  - 해당 패킷의 출발지 IP 가 과거에 내부 호스트가 접속했던 IP라면 허용한다
  - 즉 외부 IP 검사를 하며 외부 Port 는 검사하지 않는다
  - 내부가 `8.8.8.8:*` 으로 한 번이라도 나간 적이 있다면 `8.8.8.8:12345` 에서 들어오는 패킷도 허용한다
- Cone 구조로 유지되지만 IP 기준으로 한번 걸러지는 구조이다
- 장점
  - Full Cone 보다는 보안성이 높다
- 단점
  - 여전히 포트 예측 공격 가능성이 있다

</br>

### Port Restricted Cone NAT

- 상태 생성 방식으로 Restricted Cone NAT 와 동일하지만 훨씬 더 구체적인 상태를 기록한다
  - 내부 `10.0.0.10:50000` 이 외부 `8.8.8.8:53` 으로 나갔다는 사실을 IP + Port 까지 함께 기억한다
- 외부 → 내부 패킷 허용 기준
  - 출발지 IP 가 같고 출발지 Port 도 같을 때만 허용한다
- 장점
  - 상대적으로 보안성이 좋다
- 단점
  - UDP 기반 P2P 연결성이 상대적으로 좋지 않다 STUN/TURN 같은 보조 기술 필요

</br>

### Symmetric NAT

- 외부 목적지에 따라 매핑을 분리하여 판단한다
  - NAT 장비는 내부 IP/Port 를 공인 IP/Port 로 매핑할 때 해당 매핑을 어떤 외부 목적지로 나가는가 까지 포함한 세션 단위로 분리한다
  - 내부 호스트 `10.0.0.10:50000` 이 외부 서버 `198.52.100.10:443` 으로 나갈 때 NAT 가 `203.0.113.1:40000` 을 할당했다고 하더라도 같은 내부 소켓 `10.0.0.10:50000` 이 다른 외부 서버 `203.0.113.1:40000` 으로 나가면 Symmetric NAT 는 동일한 `203.0.113.1:40000` 을 재사용하지 않고 `203.0.113.1:40001` 같은 다른 공인 Port 를 새로 할당하는 경향이 있다
  - 즉 내부에서 같은 소켓이더라도 외부 목적지가 달라지면 NAT 외부 Port 가 달라지고 매핑 테이블이 외부 목적지별로 분리된다
- 외부 → 내부 패킷 허용 기준
  - 외부 IP, Port 를 확인하며 추가적으로 NAT 외부 Port 도 세션별로 고정된다

</br>

### 보안과 연결성 기준 정리

- Full Cone NAT 는 NAT 의 공인 IP/Port 로 들어오는 트래픽을 출발지에 상관없이 내부로 전달하기 때문에 연결성이 가장 좋지만 외부 노출이 크고 보안성이 제일 취약하다
- Restricted Cone NAT 는 내부가 과거에 통신했던 외부 IP에서 오는 트래픽만 내부로 전달하여 노출이 상대적으로 줄었다
- Port Restricted Cone NAT 는 내부가 과거에 통신했던 외부 IP + Port 조합에서 오는 트래픽만 내부로 전달하여 더 엄격해진 방식
- Symmetric NAT 는 내부 소켓이라도 외부 목적지별로 공인 Port 를 다르게 할당하고 해당 세션의 응답만 허용하여 보안은 강하지만 P2P 직접 연결을 가장 어렵게 만든다

> P2P (Peer-to-Peer)
>
> - P2P 는 중앙 서버를 통해서만 통신하는 구조를 피하고 통신 주체들이 서로 직접 연결되는 구조를 의미한다
> - Client-Server 모델에서 서버가 할상 트래픽의 중계자이자 병목지점일 수 있으므로 이 방식을 구조적으로 변경한 방식, 즉 데이터의 생산자와 소비자가 직접 연결되어 데이터를 주고받게 하자는 개념
> - Peer 는 단순히 클라이언트가 아닌 아래 두 가지 주체를 가진다
>   - 다른 Peer 에게 데이터를 요청하는 주체
>   - 다른 Peer 에게 데이터를 제공하는 주체
>
> WebRTC
>
> - 브라우저는 제약이 존재한다
>   - 임의의 TCP/UDP 소켓을 열 수 없다, 방화벽 및 NAT 제어 불가능 등
> - 그렇지만 웹에서는 화상 통화, 음성 통화, 실시간 화면 공유 같은 기능이 필요하다
> - WebRTC 는 해당 요구를 해결하기 위해 만들어진 브라우저 기반 실시간 통신 표준이다
> - WebRTC 는 브라우저 (또는 모바일 앱) 가 NAT 뒤에 있어도 중앙 서버의 개입을 최소화하면서 Peer 간 실시간 미디어/데이터 통신을 성립시키기 위한 프로토콜과 컴포넌트의 집합
>   - WebRTC 는 가능하면 P2P, 불가능하면 중계 서버를 사용하도록 설계된 시스템
> - Signaling
>   - 두 Peer 는 서로의 IP,Port,네트워크 상태를 알 수 없으므로 대신 WebRTC 는 Peer 간 연결에 필요한 정보를 교환하는 방법은 개발자가 WebScoekt, HTTP, MQTT 등으로 직접 구현한다고 가정한다
>   - 이 단계가 시그널링이며 시그널링 서버는 데이터를 중게하지 않는다
>   - 시그널링 서버는 SDP, ICE 정보들을 교환한다
>     - SDP (Session Description Protocol): 어떤 코덱을 사용하는지 어떤 미디어 스트림이 있는지
>     - ICE 후보: 해당 Peer 가 외부와 통신 가능한 네트워크 경로 후보들
