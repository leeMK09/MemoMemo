## 네트워크 장치의 역할, 구조 중에 하나인 Out of path

- Out of path 는 장치가 트래픽 경로에 직접 들어가지 않고 트래픽을 복제 (mirro/tap) 해서 읽기 전용으로 관찰하는 구조를 의미한다
- Packet + Read-only, Sensor 의 역할을 수행한다
- Out of path 장치는 트래픽을 직접 받는게 아닌 어딘가의 트래픽을 복제하여 장치에게 보내는 역할을 수행
  - 스위치 SPAN (포트 미러링)
  - 물리 TAP (케이블 중간에서 복제 수행)
  - 가상/클라우드 트래픽 미러링 (가상 NIC/가상 스위치 레벨)
- 해당 장치의 역할은 Read-only 이며 원칙적으로 트래픽 차단은 어렵다
- Out of path 는 보통 패킷 복제본이기 때문에 트래픽 분석시 패킷 기반 분석의 어려움이 존재한다
  - 다만 센서/분석기가 내부에서 패킷을 재조립하여 센서/스트림처럼 보여줄 수는 있다

</br>

### Out of path 구조에서의 SPI/DPI

- SPI/DPI 는 검사의 깊이를 의미한다
  - 무엇을 보는가
- Out of path + SPI
  - 미러링된 트래픽을 헤더 + 흐름 중심으로 분석
- Out of path + DPI
  - 미러링된 트래픽을 페이로드까지 분석

</br>

### SPI

- Shallow Packet Inspection 을 의미하며 얕은 이라는 말그대로 주로 패킷 헤더 or 메타데이터 중심으로 보는 방식
- 개인정보 및 통신 비밀 침해 위험이 상대적으로 낮다
  - 내용이 아닌 메타데이터, 흐름 중심으로 분석
- 처리 비용이 낮다 → 페이로드 해석, 재조립 불필요
- 암호화(HTTPS) 가 늘어날수록 SPI 비중이 커진다
  - HTTPS 에선 페이로드가 암호화되어 있으므로 DPI 가 어렵거나 복호화가 필요하다
- 구체적으로 무슨 내용을 주고받는지는 알기어렵다 → 정교한 위험 탐지에는 어렵다 (악성 페이로드)

</br>

### DPI

- Deep Packet Inspection 을 의미하며 어떤 앱/프로토콜인지까지 식별하며 경우에 따라 콘텐츠 내용까지 분석하는 기술
- 애플리케이션/콘텐츠 수준의 정교한 분류 및 통제가 가능하다
  - 특정 앱의 행위 식별이 가능하다
- 보안적으로는 탐지 정확도를 올릴 수 있다
  - 내용 기반 시그니처, 데이터 유출 패턴, 악성 코드 일부 패턴 분석가능

**DPI 의 위험성**

- 통신 비밀 및 프라이버시 침해 가능성이 매우 높다
  - DPI 는 기술적으로 내용에 접근할 수 있기 때문에 보안 위험이 높다
- DPI 로 트래픽을 차별 혹은 우선순위 차단시 고객 입장에서는 ISP가 콘텐츠를 골라서 취급하는 문제로 이어질 가능성이 존재한다
- 복호화(TLS 등)를 하면서 사실상 내용 열람시 규범 및 법적 정당성이 중요해짐

> 망중립성
>
> ISP (통신사/망 사업자) 가 합법적 트래픽을 임의로 차단/감속/우선처리(감별)하지 말자는 원칙
> DPI 는 트래픽이 무엇인지 식별 가능하므로 차별적 트래픽 관리에 악용될 수 있다는 우려가 크다 → 특정 서비스만 느리게 혹은 빠르게, 특정 앱 차단 등

> SPI 는 가능, DPI 는 불법?
>
> - DPI 는 기술적으로 감청(통신 내용 접근)과 가까워질 우려가 있으므로 위험
> - 일반적으로 이용자 트래픽 내용을 들여다보는 형태의 DPI 는 통신 비밀 및 프라이버시 원칙과 충돌하며 법적 정당화가 어렵다

</br>

### 세가지 네트워크 장치 구조

1. inline 구조

   - 장치가 실제 트래픽 경로에 들어가서 트래픽이 장치를 통과해야만 목적지로 갈 수 있는 구조
   - 패킷 단위 필터링 수행 → Drop / Bypass
   - 예시) 방화벽, IPS, 일부 DDos 장비, NAT/라우터 등

2. Out of path 구조

   - 직접 들어가지 않고 트래픽을 복제해서 읽기 전용으로 관찰하는 구조
   - 예시) IDS, NDR, 트래픽 분석기 등

3. Proxy 구조

   - 중간 대리인 형태이며 클라이언트와 서버가 직접 통신하지 않고 프록시가 양쪽과 각각 연결을 맺는 구조
   - Proxy 는 OS 소켓에서 재조립된 TCP 스트림을 받으며 HTTP 분석시 Application 레벨에서 수행해야한다 → Proxy 가 TSL 를 종단한다면 HTTP 내용을 평문으로도 분석 가능
   - 예시) Reverse Proxy, API Gateway, WAF, Service Mesh Proxy 등
