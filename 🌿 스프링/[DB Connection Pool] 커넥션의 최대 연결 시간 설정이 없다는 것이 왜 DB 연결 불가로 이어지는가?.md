## "커넥션의 최대 연결 시간 설정이 없다" 는 것이 왜 DB 연결 불가로 이어지는건가?

**먼저 커넥션 풀(Connection Pool) 이란?**

- WAS (서버) 가 DB 에 연결할 때마다 새로운 TCP 연결을 만드는 건 비용이 크니까, 일정 개수의 DB 연결을 미리 열어두고 재사용하는 구조입니다
- 이 커넥션들은 일정 시간 동안 살아있을 것이라는 전제를 가집니다
  - `idle timeout`, `max lifetime` 같은 설정이 존재

</br>

**최대 연결 시간(`max lifetime`) 이 없다면?**

- 커넥션 풀 안의 각 연결이 언제까지 유효한지에 대한 관리가 없다
- 시간이 지나도 오래된 연결을 "내가 알아서" 닫지 않고 계속 보관합니다

</br>

**문제 발생 포인트**

- 네트워크 장비 (방화벽, LB, NAT) 나 DB 서버 측에서는 오래된 커넥션을 어느 순간 끊어버릴 수 있습니다
- 예를 들어 DB 서버가 30분 이상 idle 된 세션을 강제로 끊는다거나, 중간의 방화벽이 idle TCP 세션을 10 뒤에 drop 시킨다는 등
- 그런데 **커넥션 풀은 그걸 모른다!** → 여전히 "이 연결이 살아있네?" 하고 그대로 빌려준다
- 이후 실제로 쿼리가 발생하게 되면 이미 끊어진 TCP 소켓이라서 에러가 발생한다
  - `SQLTransientConnectionException`, `Communications link failure` 등

</br>

**원인과 증상**

- 원래라면 커넥션 풀에서 `maxLifetime` 같은 값을 주어 오래된 연결을 주기적으로 폐기하고 새로 맺어야 한다
- 하지만 설정이 없으면 **끊어진 오래된 커넥션을 계속 재사용하려다가 에러 방생 → 서버 입장에서는 DB 로 연결할 수 없는 것 처럼 보이는 상황이 발생**

</br>
</br>

### 즉, 커넥션의 최대 연결 시간 설정이 없다면?

- 오래된 커넥션을 폐기하지 않고 계속 풀에 유지
- 중간 네트워크나 DB 가 세션을 끊어도 풀은 모른다
- 결국 "끊어진 소켓"을 빌려주고 쿼리는 실패된다
- 결과적으로 **서버에서 DB로 연결할 수 없는 것 처럼 보이는 문제**가 생긴다

</br>

**HikariCP 커넥션 풀 설정**

```yaml
spring.datasource.hikari.max-lifetime: 1800000 # 30분
spring.datasource.hikari.idle-timeout: 600000 # 10분
```

이런식으로 설정해 주기적으로 커넥션을 교체하게 만들어야 한다

→ DB 네트워크 환경 (방화벽, LB, DB 자체의 idle timeout) 을 파악한뒤, **그 시간보다 짧게 maxLifetime을 잡는 것** 이 보통이다
