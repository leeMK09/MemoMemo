## 외부 연동과 트랜잭션 처리

- DB 연동과 외부 연동을 함께 실행할 때는 오류 발생 시 DB 트랜잭션을 어떻게 처리할지 알맞게 판단해야 한다
- 하지만 **읽기 타임아웃이 발생해 트랜잭션을 롤백할 때**는 회부 서비스가 실제로는 성공적으로 처리했을 가능성을 염두에 두어야 한다

![외부연동_트랜잭션처리](./img/외부연동_트랜잭션처리.png)

트랜잭션을 롤백했을 때 외부 서비스가 실제로 성공했을 경우, 두 가지 방법 중 하나를 검토해야 한다

1. 일정 주기로 두 시스템의 데이터가 일치하는지 확인하고 보정하는 방법

   - 주문 서비스와 포인트 서비스가 하루에 한 번씩 전날 포인트 사용 내역을 비교해 불일치 건이 있는지 확인 및 발견시 수동 or 자동으로 보정

2. 성공 확인 API 혹은 읽기 타임아웃 에러시 취소 API 를 요청하는 방법
   - 읽기 타임아웃이 발생된 후 일정 시간 후 성공했는지 확인 API 요청 혹은 읽기 타임아웃 발생시 취소 API 호출
   - 이 방식은 연동 서비스가 성공 확인, 취소 API 를 제공해야 하는 전제가 있다

두 시스템 간 데이터 일관성이 중요한 기능이라면 정기적으로 데이터 일치를 확인하는 프로세스를 갖추는 것이 좋다

</br>
</br>

## 외부 연동이 느려질 때 DB 커넥션 풀 문제

- 외부 연동이 느릴때에도 DB 커넥션을 계속 붙잡고 있다면
- 이후에 들어오는 많은 요청에 대해 커넥션 풀이 모두 소진되어 결국 DB 쿼리를 실행하지 않는 상황인데도 DB 커넥션이 모두 점유된 상태가 되는 아이러니한 상황이 발생한다

DB 연동과 무관하게 외부 연동을 실행할 수 있다면, DB 커넥션을 사용하기 전이나 후에 외부 연동을 시도하는 방안도 고려해볼 수 있다

단, 이 방식은 외부 연동이 트랜잭션 범위 밖에서 실행되기 때문에 트랜잭션 커밋 이후 외부 연동이 실패하면 롤백이 불가능하다는 점을 고려해야 한다

후처리 방법으로는 트랜잭션으로 반영된 데이터를 되돌리는 보상 트랜잭션을 사용하는 방법 또는 기능 특성에 따라 데이터를 후보정하는 방법 등이 있다
