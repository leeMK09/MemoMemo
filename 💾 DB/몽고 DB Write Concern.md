## Write Concern

- MongoDB 에서 Write Concern 은 클라이언트가 쓰기 요청을 보낼 때 MongoDB에게 성공 응답을 언제 돌려줘야 하는지를 요구하는 규칙이다
- 응답을 보내기 전에 몇 개의 노드가 쓰기를 확인해야 하는가를 `w` 값으로 결정한다
    - `w` 는 Primary만 확인할지 Secondary까지 몇 대 확인할지, 혹은 투표 과반수를 확인할지 같은 복제 관점의 확장성을 다룬다
- 각 노드가 확인했다고 말할 때 그 확인이 메모리 반영만으로 충분한지 아니면 디스크 저널(journal) 기록까지 끝나야 하는지를 `j` 옵션으로 결정한다
    - 이 부분이 장애(프로세스 크래시 등)에서 살아남는가 라는 내구성과 직접 연결된다
- 즉 Write Concern 은 성공 응답이라는 신호를 복제 확장(몇 대가 반영되었는가) 과 디스크 내구성 (저널까지 갔는가) 로 분해해서 제어하는 장치이다

</br>

### ACKNOWLEDGED / UNACKNOWLEDGED

**UNACKNOWLEDGED**

- `w: 0`
- fire and forget 의 개념
- Write Concern 의 설정 중에 하나
- 해당 설정을 사용하면 클라이언트는 서버로 요청을 보낸 뒤 서버가 실제로 처리했는지(권한 오류가 났는지, 네트워크가 끊겼는지, Primary가 내려갔는지)와 무관하게 성공처럼 응답할 수 있다
- 장점은 지연시간이 줄어들며 문제는 대부분의 서비스에서 장애 시 데이터 유실/불일치 리스크를 정당화하기 어렵다
- 특히 장애 분석 관점에서 성공이라고 로그가 찍히며 실제 데이터는 반영되지 않는 데이터 불일치 문제가 발생한다

**ACKNOWLEDGED**

- `w: 1`
- Write Concern 의 설정 중에 하나
- ACKNOWLEDGED 는 클라이언트가 서버의 확인을 기다리는 모드이다
- 보통 Primary 는 해당 쓰기를 처리했다고 확인하는 순간(대개 메모리에 반영된 시점)에 응답을 받는다
- 이때 Secondary에 복제되었는지까지는 기본적으로 확인하지 않는다

</br>

### w:1, w:2, w:3

- 복제 확인을 몇 대까지 기다릴 것인가를 강제한다
- `w` 에 숫자를 주면 Primary를 포함해서 해당 숫자만큼의 Replica Set 멤버가 쓰기를 확인해야 성공을 돌려준다
    - 예를 들어 `w:2` 는 Primary + Secondary 최소 1대의 확인을 요구한다
- `w:1` 에서는 Primary 가 ACK 를 주자마자 성공이므로 그 직후 Primary 가 장애로 내려가고 Secondary 가 아직 복제를 못 받았으면 해당 쓰기가 롤백되거나 유실될 가능성이 생긴다
- `w:2` 이상은 Secondary까지 반영된 것을 확인한 뒤 성공이므로 Primary 단독 장애 같은 시나리오에서 유실 가능성을 낮춘다
- 하지만 `w` 값을 키울수록 쓰기 지연시간은 가장 느린 참여 노드의 속도로 정해진다 또한 Secondary 가 장애이거나 지연 중이면 쓰기가 타임아웃/실패로 보이기 쉬워 가용성이 떨어진다
- 즉 `w:n` 은 내구성과 일관성을 얻는 대신 지연시간과 가용성을 비용으로 치르는 트레이드 오프

</br>

### w: majority

- 과반수의 데이터 보유 노드에 반영되었다를 성공 기준으로 삼는다
    - 숫자 대신 투표 과반수를 기준으로 성공을 정의한다
- 이 방식의 목적은 Replica Set 에서 Primary 가 바뀌는 선거(election)과 결합했을 때 새로운 Primary 가 되려면 과반수의 동의를 받아야한다 라는 성질과 쓰기 확장을 맞춰 성공으로 응답된 쓰기가 장애 이후에도 살아남을 가능성을 크게 높이는 것이다
- 중요한 건 MongoDB 는 과반수 계산에서 arbiter(중재자) 를 투표 멤버로 포함시키지만 arbiter 는 데이터를 저장하지 않는다
    - 그래서 arbiter 가 여러 개 있거나 Primary-Secondary-Arbiter 같은 구조에서는 majority 성공이 다수의 데이터 보유 노드에 반영과 1:1 로 일치하지 않는 상황이 생길 수 있다

</br>

### JOURNALED

- `j:true`
- 각 노드가 ACK 를 주기 전에 해당 노드가 쓰기를 온디스크 저널 파일에 기록하도록 요구한다
    - 저널(journal) : 크래시 복구를 위한 재실행 로그, WAL에 가까운 역할
- Primary 가 쓰기를 메모리에만 반영한 상태에서 전원 장애나 프로세스 크래시가 나면 재시작 후 해당 쓰기가 사라질 수 있다. 적어도 저널에는 데이터를 남겼다를 성공 조건에 포함시키므로 이런 유실 가능성을 낮춘다
- 반대로 디스크 I/O를 동반하는 경향이 있으므로 쓰기 지연시간 증가와 디스크 병목 가능성을 비용으로 치른다
- 그리고 MongoDB 는 `w: majority` 에서 저널까지 기다릴지를 `writeConcernMajorityJournalDefault` 라는 Replica Set 설정으로 제어한다
    - 기본값은 `true` 이며 이 값이 `true` 면 `w: majority` 설정에도 과반수 멤버가 저널에 기록할 때까지 기다린 뒤 ACK 하도록 동작한다
- Journal 파일은 본질적으로 로그성 데이터이기 때문에 장애가 발생했을 때 캐시에만 존재하던 변경 사항도 WAL 로그를 replay 함으로써 복구하는 데 사용
- 이후 특정 조건이 충족되면 flush 혹은 checkpoint 가 발생하며 이 시점에 WAL 에 기록되어 있던 변경 내용이 모두 실제 데이터 파일 (.wt) 에 반영된다
- 이렇게 데이터 파일에 반영되면 해당 WAL 로그는 더 이상 필요 없는 로그로 간주되어 정리될 수 있다

**흐름**

1. 클라이언트가 쓰기 요청(데이터 추가 등)을 보내면 MongoDB 엔진에 도달
2. 엔진은 우선 메모리 캐시에 해당 데이터를 반영
3. 이렇게 메모리에 먼저 데이터를 올려 두면 같은 데이터에 대한 추가 요청이 들어왔을 때 빠르게 응답 가능
4. 이때 캐시에만 적용된 페이지를 더티 페이지라고 부르고 캐시에 반영하는 것과 동시에 WAL, 즉 Journal 로그 파일에 변경 내용을 바로 기록
