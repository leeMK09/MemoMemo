## MongoDB 격리 수준

- MongoDB 는 전통적인 SQL 수준(READ COMMITTED, REPEATABLE READ 등)을 그대로 채택하지 않고 동작 특성이 부분적으로 READ COMMITTED 에 가깝도록 설계된 모델을 사용한다
- 일반적인 관계형 데이터베이스에서 말하는 READ COMMITTED 격리 수준은 각 SELCT 문이 실행되는 시점에 이미 커밋된 데이터만 읽도록 보장한다
- MongoDB 는 read concern 과 write concern 이라는 독자적인 개념을 통해 읽기와 쓰기의 가시성 안정성을 정의한다

**read concern**

- MongoDB 에서 기본적으로 사용되는 read concern 은 `local` 이다
- 이 설정 하에서 MongoDB는 현재 노드(Primary 또는 Secondary) 에 로컬로 커밋된 데이터를 읽도록 허용한다, 중요한 점은 해당 커밋이 트랜잭션 커밋이 아닌 해당 노드 메모리와 스토리지에 반영된 상태를 의미한다는 점이다
- 이로 인해 다음과 같은 동작 특성을 나타낸다
    - 하나의 클라이언트가 데이터를 조회할 때 아직 커밋되지 않은 다른 연산의 중간 상태는 절대로 읽지 않는다
- MongoDB 는 statement (문) 단위로 현재 노드에 반영된 최신 데이터를 읽는다

**명시적인 트랜잭션 사용시**

- MongoDB 가 명시적 트랜잭션(`session.startTransaction()`)을 사용할 때 snapshot 기반 일관성 모델을 사용한다
    - 트랜잭션 시작 시점의 일관된 스냅샷을 기준으로 읽는다
    - 트랜잭션이 끝날 때까지 같은 쿼리는 같은 결과를 본다
    - 즉 스냅숏 격리(Snapshot Isolation)가 적용된다
- MongoDB 에서 멀티 도큐먼트 트랜잭션을 사용하지 않는 일반 CRUD 연산은 트랜잭션이라는 논리적 단위 자체가 존재하지 않는다
- MongoDB 의 트랜잭션 격리 모델은 Replica Set + 멀티 도큐먼트 트랜잭션 + snapshot read concern 이 결합될 때 수행된다 → Snapshot Isolation

</br>

## Snapshot Isolation

- 하나의 트랜잭션이 시작되는 시점에 존재하던 데이터베이스의 상태를 스냅숏으로 고정하고 트랜잭션이 끝날 때까지 항상 동일한 시점의 데이터만 읽도록 보장하는 격리 방식
    - 트랜잭션 시작 시점이 기준
    - 그 이후 다른 트랜잭션이 커밋한 변경은 보이지 않는다
    - 트랜잭션 안에서는 같은 쿼리를 여러 번 실행해도 항상 같은 결과를 본다
- 즉 각 트랜잭션은 자기만의 과거 시점 데이터베이스를 보고 일한다 라고 이해하면 된다

**MongoDB 의 Snapshot Isolation**

- MongoDB(WiredTiger 스토리지 엔진)은 다음과 같은 구조를 가진다
    - 하나의 문서에 대해 여러 버전(version)을 유지
    - 각 쓰기 작업은 이전 버전을 덮어쓰는 것이 아닌 새로운 버전을 생성
- 이후 트랜잭션 시작 (`session.startTransaction()`) 시 `read timestamp` 가 고정된다
    - 트랜잭션이 시작되면 MongoDB 는 내부적으로 다음을 기록한다
    - 해당 트랜잭션이 어떤 시점의 커밋된 데이터까지 볼 수 있는지 → 즉 해당 트랜잭션의 가시성 경계를 기록
    - 해당 경계 이후에 생성된 데이터 버전은 커밋되었든 아니든 해당 트랜잭션에서는 절대 보이지 않는다
- 읽기 시 항상 스냅숏 기준 필터링 수행
    - 트랜잭션 내부에서 문서를 읽을 때 해당 문서의 여러 버전 중에서 트랜잭션의 read timestamp 이전에 커밋된 버전만 선택하고 나머지는 전부 무시한다
    - 이 때문에 같은 문서를 여러 번 읽어도 결과가 동일하고 다른 트랜잭션의 변경으로 결과가 바뀌지 않는다

**Snapshot Isolation 을 트랜잭션에서만 제공하는 이유**

간단하게 정의하자면 Snapshot Isolation 은 비용이 발생한다

1. 오래된 버전 유지
    - 트랜잭션이 오래 실행되면 과거 버전을 삭제할 수 없음
2. 동시성 제약이 생김
    - Snapshot Isolation 은 읽기에는 강하지만 쓰기 충돌이 발생할 수 있다
    - MongoDB 는 이를 감지하면 트랜잭션을 롤백시킨다
    - 트랜잭션은 재시도 비용을 전제로 한 기능
3. 분산 환경에서 더 비싸다
    - replica set 전체에서 동일한 스냅샷 시점을 유지해야 하며 커밋 시 다수 노드의 합의가 필요
    - 그래서 standalone MongoDB 에서는 트랜잭션을 지원하지 않는다
